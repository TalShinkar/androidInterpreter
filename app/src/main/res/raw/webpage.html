<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
        <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
        <style type="text/css">
			body {
				margin: 0px;
				padding: 0px;
				height: 99%;
				background-color: black;
			}
			textarea#setter  {
				left: -1000px;
				position: absolute;
			}
			.cursor {
				font-size: 12px;
				background-color: black;
				color: black;
				position: relative;
			}
			#terminal {
				margin: 8px;
				cursor: text;
				height: 500px;
				overflow: auto;
			}
			#writer {
				font-family: cursor, courier;
				color: white;
			}
	        #getter {
	            margin: 5px;
	        }
		</style>
    </head>
    <body>
        <div id="terminal">
            <textarea type="text" id="setter"></textarea>
            <div id="getter">
                <font color="#00c500" style="font-family: cursor, courier;font-weight: bold;">android@phone</font>
                <font color="white" style="font-family: cursor, courier;font-weight: bold;"> :</font>
                <font color="cyan" style="font-family: cursor, courier;font-weight: bold;"> ></font>
                <span id="writer"></span><b class="cursor" id="cursor">B</b>
            </div>
        </div>
        <script type="text/javascript">
        var cursor = $("#cursor");
		var setter = $("#setter");
		var writer = $("#writer");
		var terminal = $("#terminal");
		window.addEventListener("keydown",
		function(e){
		    if ([8].indexOf(e.keyCode) > -1 && setter[0].value[setter[0].value.length-1] == "\n")
    		    e.preventDefault();
			if([37,38,39,40,9].indexOf(e.keyCode) > -1)
				e.preventDefault();
		},false);

		$(cursor).css("left", "0px");

        function httpCall(params, callback){
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    if(callback) callback(this);
                }
            };

            arguments = "";
            for (var key in params) {
                // check if the property/key is defined in the object itself, not in parent
                if (params.hasOwnProperty(key) && params[key]) {
                    arguments += "&" + key + "=" + params[key]
                }
            }
            arguments = "?" + arguments.substring(1);

            console.log(arguments);
            xhttp.open("GET", arguments, true);
            xhttp.send();
        }


		function runscript(code){
            httpCall({code: code}, function(response) {
                console.log(writer);
                setter[0].value = setter[0].value.substring(0, setter[0].value.length - 1) + '<br>';
                console.log(response);
                setter[0].value +=  response.responseText;
                writer.html(nl2br(setter[0].value));
            })
		}

		function nl2br(txt){
			return txt.replace(/\n/g, '<br />'+
			'<font color="#00c500" style="font-family: cursor, courier;font-weight: bold;">android@phone</font>'+
			'<font color="white" style="font-family: cursor, courier;font-weight: bold;"> :</font>'+
			'<font color="cyan" style="font-family: cursor, courier;font-weight: bold;"> \> </font>');
		}
		function writeit(from, e){
            var code = e.keyCode || e.which;
            if (code == '9') {
                console.log(from.value);
                code_start = from.value.lastIndexOf('\n') + 1;
                real_code = from.value.substring(code_start);

                var i, last_special = 0;
                for(i = 0; i < real_code.length; ++i) {
                    if(['.', ';', ',', '(', ')', '='].includes(real_code[i]))
                        last_special = i + 1;
                }

                token = real_code.substring(last_special);
                httpCall({autocomplete: true, fetch: true, token: token}, function(response) {
                    console.log(response.responseText);
                    console.log("~ do the auto complete dance ~");
                });
            }
            else if(e.originalEvent.key == "Enter"){
			    enter_pos = from.value.length - 1;
			    all_code = from.value.substring(0, enter_pos)
			    new_code_start = all_code.lastIndexOf('\n') + 1;
			    new_code = all_code.substring(new_code_start)
			    runscript(new_code)
			}
			else{
    			e = e || window.event;
    			var w = $(writer);
    			var tw = from.value;
    			w.html(nl2br(tw));
			}
		}
        function blink(){
            if($(cursor).css("display") == "none"){
                $(cursor).css("display","inline");
            } else {
            	$(cursor).css("display","none");
            }
        }
        setInterval("blink()", 500);
        $(terminal).click(function(){
        	$(setter).focus();
        });
		$(setter).keyup(function(event){
			writeit(this, event);
		});

        last_piece = '';
        var_name = undefined;

        $(setter).bind('input propertychange', function(e) {
            code_start = this.value.lastIndexOf('\n') + 1;
            new_code = this.value.substring(code_start);

            if (Math.abs(new_code.length - last_piece.length) != 1) {
                httpCall({autocomplete: true, clear: true}, undefined);
                var_name = undefined;
            }

            else if(new_code.length > last_piece.length) { // new char
                new_char = new_code[new_code.length - 1];

                if (new_char == '=') {
                    parts = new_code.substring(0, new_code.length - 1).trim().split(" ");
                    var_name = parts[parts.length - 1];
                }

                if ([';', ',', '(', '.', ')'].includes(new_char)) {
                    var i, last_special = 0;
                    for(i = 0; i < new_code.length - 1; ++i) {
                        if(['.', ';', ',', '(', ')', '='].includes(new_code[i]))
                            last_special = i + 1;
                    }

                    for(i = new_code.length - 2; i >= 0 && new_code[i] != ' '; --i);
                    if(new_code[i] != ')') {
                        token = new_code.substring(last_special, new_code.length - 1).trim();
                        httpCall({autocomplete: true, token: token, varname: var_name, new_stack: ! (['.', ')'].includes(new_char)) }, undefined);
                        // console.log("make request: new command with {" + token + "," + var_name + "}");
                    }
                }

                if (new_char == ')') {
                    var open_bracket = new_code.length - 2, last_special = 0;
                    var brackets_balance = 1;

                    while(brackets_balance != 0) {
                        if(new_code[open_bracket] == ')')
                            brackets_balance++;
                        if(new_code[open_bracket] == '(')
                            brackets_balance--;
                        open_bracket--;
                    }
                    open_bracket++;

                    for(i = 0; i < open_bracket; ++i) {
                        if(['.', ';', ',', '(', ')', '='].includes(new_code[i]))
                            last_special = i + 1;
                    }

                    var params = new_code.substring(open_bracket, new_code.length - 1).trim();
                    var num_arguments = (params.match(/,/g) || []).length;
                    num_arguments = (num_arguments == 0) ? (( params.length > 1 ) - 0) : (num_arguments + 1);

                    name = new_code.substring(last_special, open_bracket).trim();
                    httpCall({autocomplete: true, function: name, nargs: num_arguments}, undefined);
                    // console.log("make request: func_handler with {" + num_arguments
                    //     + ", "+ new_code.substring(last_special, open_bracket).trim() + "}")
                }
            } else { // char removed
                var i, removed_char = last_piece[last_piece.length - 1];
                for(i = new_code.length - 2; i >= 0 && last_piece[i] != ' '; --i);
                if(last_piece[i] != ')' && ['.', ';', ',', '(', ')'].includes(removed_char))
                    httpCall({autocomplete: true, removed_char: removed_char}, undefined);
            }

            last_piece = new_code;
        });
	</script>
    </body>
</html>
